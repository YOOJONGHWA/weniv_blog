# 데드락

#### 데드락 문제

- Deadlock

  - 일련의 프로세스들이 서로가 가진 자원을 기다리며 block된 상태

- Resource(자원)

  - 하드웨어, 소프트웨어 등을 포함하는 개념

  - ex) I/O devicem CPU cycle, memory space, semaphore등

---

#### 데드락 발생 조건

- Mutual exclusion

  - 매 순간 하나의 프로세스만이 자원을 사용할 수있음

- No preemption(비선점)

  - 프로세스는 자원을 스스로 내어놓을 뿐 강제로 뺴앗기지 않음

- Hold and Wait(보유 대기)

  - 자원을 가진 프로세스가 다른 자원을 기다릴 때 보유 자원을 높지 않고 계속 가지고 있음

- Circular wait(환형 대기)

  - 자원을 기다리는 프로세스간에 사이클이 형성되어야 함

---

#### Deadlock의 처리 방법

- Deadlock Prevention

  - 자원 할당시 Deadlock의 4가지 필요 조건 중 어느 하나가 만족되지 않도록 하는것

- Deadlcok Avoidance

  - 자원 요청에 대한 부가적인 정보를 이용해서 deadlock의 가능성이 없는 경우에만 자원을 할당

  - 시스템 state가 원래 state로 돌아올 수 있는 경우에만 자원 할당

- Deadlcok Detection and recovery

  - Deadlcok 발생은 허용하되 그에 대한 detection 루틴을 두어 deadlock 발견시 recover

- Deadlock Ignorance

  - Deadlock을 시스템이 책임지지 않음

  - UNIX를 포함한 대부분의 OS가 채택

---

#### Deadlock Prevention

- Mutual exclusion

  - 공유해서는 안되는 자원의 경우 반드시 성립해야 함

- No preemption(비선점)

  - process가 어떤 자원을 기다려야 하는 경우 이미 보유한 자원이 선점됨

  - 모든 필요한 자원을 얻을 수 있을 때 그 프로세스는 다시 시작

  - State를 쉽게 save하고 restore할 수 있는 자원에서 주로 사용(CPU, memory)

- Hold and Wait(보유 대기)

  - 프로세스가 자원을 요청할 때 다른 어떤 자원도 가지고 있지 않아야 한다.

  - 방법1

    - 프로세스 시작 시 모든 필요한 자원을 할당받게 하는 방법

  - 방법2

    - 자원이 필요할 경우 보유 자원을 모두 놓고 다시 요청

- Circular wait(환형 대기)

  - 모든 자원 유형에 할당 순서를 정하여 정해진 순서대로만 자원 할당

---

#### Deadlock Avoidance

- **자원 할당 그래프(Resource Allocation Graph, RAG)**

  - 자원 할당 그래프는 시스템 내에서 자원과 프로세스를 나타내는 방향성 그래프입니다. 각 노드는 프로세스나 자원을 나타내며, 엣지는 프로세스가 자원을 요청하거나 자원을 점유하고 있는 관계를 나타냅니다.

  **데드락을 방지하는 조건:**

  - 프로세스가 자원을 요청할 때, 시스템은 요청을 허락하기 전에 그 요청이 자원 할당 그래프에서 사이클을 만들지 않는지 검사합니다. 사이클이 발생할 경우, 요청은 거절됩니다.
  - 시스템은 자원을 할당할 때 사이클을 방지할 수 있는 방식으로 자원을 관리합니다.

- **은행가 알고리즘(Banker's Algorithm)**

  - 은행가 알고리즘은 여러 종류의 자원을 가진 시스템에서 사용되는 데드락 회피 알고리즘입니다. 이 알고리즘은 은행이 대출을 승인할 때처럼, 자원을 할당하기 전에 시스템이 안전 상태에 있을지 여부를 확인하는 방식으로 동작합니다.

  **작동 원리:**

  - 시스템은 각 프로세스가 최대 얼마의 자원을 요구할지에 대한 정보와 현재 할당된 자원 정보를 추적합니다.
  - 프로세스가 자원을 요청하면, 시스템은 이 요청을 처리했을 때 모든 프로세스가 완료될 수 있는지 계산합니다. 만약 어떤 요청을 처리했을 때 시스템이 안전 상태에 있다면, 자원을 할당하고 그렇지 않으면 요청을 거절합니다.

- **사전 예방적 자원 할당 (Prevention by Ordering Resources)**

  - 자원에 순서를 부여하여 자원 요청을 관리하는 방법입니다. 모든 자원에 고유한 순서를 지정하고, 프로세스는 자원을 요청할 때 항상 이 순서대로 자원을 요청해야 합니다.

  예를 들어, 자원 A, B, C가 있을 때, 프로세스가 자원 A를 요청했다면, 그 후에는 반드시 자원 B나 C를 요청해야 하고, B를 요청한 후에는 C를 요청해야 합니다. 이렇게 하면 순서대로 자원을 요청하고 할당하므로, 자원 순서가 어긋날 때 데드락이 발생할 확률을 낮출 수 있습니다.

- **데드락 회피의 핵심**
  - 데드락 회피의 핵심은 시스템이 자원을 할당할 때 **안전 상태(safe state)**를 보장하는 것입니다. 시스템은 자원 할당을 결정할 때, 그 결과가 데드락을 일으킬 가능성이 없다는 것을 보장해야 합니다. 이를 통해 프로세스들이 서로 기다리지 않도록 하여 시스템이 항상 실행될 수 있도록 관리하는 것이 데드락 회피의 목표입니다.
